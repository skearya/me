---
import Layout from "../layouts/Layout.astro";
import Ocean from "../components/ocean/Ocean.astro";
import Star from "../icons/Star.astro";
import RightArrow from "../icons/RightArrow.astro";
import Close from "../icons/Close.astro";
import { render } from "astro:content";
import { getCollection } from "astro:content";
import GitHub from "../icons/GitHub.astro";
import { getProjects } from "../utils";
import Guy from "../icons/Guy.astro";

const entries = getProjects();

const projectsReadmesCollection = await getCollection("projects");

const projectReadmes = await Promise.all(
	projectsReadmesCollection.map(async (project) => ({
		id: project.id.replaceAll(".", ""),
		md: await render(project),
	}))
);

const projectsWithoutReadmes = entries
	.flatMap(([, projects]) =>
		projects.map((project) => ({
			id: project.name.replaceAll(".", ""),
			description: project.description,
		}))
	)
	.filter((project) =>
		projectReadmes.every((readme) => readme.id !== project.id)
	);

const scriptData = entries.flatMap(([year, projects]) =>
	projects.map((project) => ({
		...project,
		id: project.name.replaceAll(".", ""),
		year,
	}))
);
---

<Layout title="skeary.me" og={{ title: "skeary.me" }} disableNav>
	<Ocean
		oceanClass="background-transition-options h-screen w-screen overflow-y-scroll"
		wavesClass="background-transition-options"
		scrollable
	>
		<div
			class="appear relative mx-auto mt-20 flex w-full items-center justify-between p-6 font-mono md:max-w-lg"
		>
			<div>
				<h1 class="mb-0.5 whitespace-nowrap text-xl">
					hello, i'm skeary
				</h1>
				<h1 id="time" class="mb-1.5 text-monochromeCat"></h1>
				<div class="mb-4 flex gap-x-2.5 text-monochromeCat underline">
					<a href="#intro">about</a>
					<a href="#projects">projects</a>
					<a href="https://skeary.me/blog">blog</a>
				</div>
				<div class="flex gap-x-2.5">
					{
						[
							{
								icon: "github",
								link: "https://github.com/skearya",
							},
							{
								icon: "email",
								link: "mailto:bradleycrasto@icloud.com",
							},
							{
								icon: "discord",
								link: "https://discord.com/users/681208628350418977",
							},
						].map(({ icon, link }) => (
							<a href={link} target="_blank">
								<img
									src={`/hello-icons/${icon}.svg`}
									height="32"
									width="32"
									alt={icon.toUpperCase()}
								/>
							</a>
						))
					}
				</div>
			</div>
			<img
				class="bounce"
				height="125"
				width="125"
				src="/cat.svg"
				alt="cat"
			/>
		</div>
		<div id="intro" class="mx-auto mt-16 w-full max-w-3xl">
			<div
				class="relative mx-4 flex min-h-80 flex-col items-start justify-stretch overflow-hidden rounded-lg md:flex-row"
			>
				<p
					class="flex-1 self-stretch bg-gradient-to-b from-moonlightFocusLow/50 to-moonlightFocusLow p-8 text-4xl md:bg-gradient-to-r"
				>
					hello!
				</p>
				<div
					class="space-y-4 self-stretch bg-moonlightFocusLow p-8 pt-0 md:max-w-md md:pt-8"
				>
					<p>
						i love building cool things and understanding how
						computers do the unreasonable things we ask for. i'm
						interested in compilers, web development, and low-level
						programming among other topics.
					</p>
					<p>
						i used to be <a
							href="https://scoresaber.com/u/76561198365846923"
							target="_blank">ranked top 100</a
						> globally in <a
							href="https://store.steampowered.com/app/620980/Beat_Saber/"
							target="_blank">Beat Saber</a
						> after 4 years of playing.
					</p>
					<p>
						in my free time i enjoy playing games, watching anime,
						and music production.
					</p>
				</div>
				<Guy
					width={320}
					height={320}
					class="absolute -bottom-14 -left-14 opacity-5 md:opacity-100"
				/>
			</div>
		</div>
		<div id="projects" class="mx-auto mt-20 w-full max-w-5xl">
			<div
				class="mx-4 grid grid-cols-1 items-stretch gap-3 sm:grid-cols-2"
			>
				{
					entries.map(([year, projects], i) => (
						<>
							<div class="col-span-1 mb-1.5 w-min rounded-sm bg-gradient-to-r from-moonlightIndigo to-moonlightPink px-1 py-0.5 font-mono text-4xl text-moonlightBase sm:col-span-2">
								{year}
							</div>
							{projects.map((project) => (
								<button
									class="project-open-button group flex flex-col overflow-hidden rounded-md border bg-moonlightBase/50 text-left transition-colors hover:border-moonlightPink hover:bg-moonlightBase/85"
									data-id={project.name.replaceAll(".", "")}
								>
									<img
										class="object-cover"
										src={project.thumbnail}
										alt={project.name}
										width="1280px"
										height="720px"
									/>
									<div class="flex h-full w-full flex-col gap-4 p-4">
										<div class="flex h-full justify-between gap-2.5">
											<div>
												<h1>{project.name}</h1>
												<p class="text-sm text-monochromeCat">
													{project.description}
												</p>
											</div>
											<div class="origin-right self-center text-moonlightIndigo transition-transform group-hover:scale-125 group-hover:text-moonlightPink">
												<RightArrow
													width={30}
													height={30}
												/>
											</div>
										</div>
										<hr />
										<div class="flex gap-3">
											{project.stack.map((item) => (
												<a
													class="transition-transform hover:-translate-y-1"
													href={item.url}
													target="_blank"
												>
													<img
														src={item.icon}
														alt={item.name}
														title={item.name}
														height="25px"
														width="25px"
													/>
												</a>
											))}
										</div>
									</div>
								</button>
							))}
							{i !== entries.length - 1 && (
								<div class="col-span-1 my-8 flex items-center gap-x-2 sm:col-span-2">
									<Star
										width={25}
										height={25}
										class="animate-spin-slow text-moonlightIndigo"
									/>
									<div class="h-[1px] w-full rounded-full bg-gradient-to-r from-moonlightIndigo to-moonlightPink" />
									<Star
										width={25}
										height={25}
										class="animate-spin-slow text-moonlightPink"
									/>
								</div>
							)}
						</>
					))
				}
			</div>
		</div>
		<div class="mt-20"></div>
	</Ocean>
	<div
		id="project-info-container"
		class="info-transition-options fixed left-0 top-0 flex h-full w-full translate-y-full items-end justify-center"
		data-projects={JSON.stringify(scriptData)}
	>
		<div
			style="scrollbar-width: thin;"
			class="h-[90%] w-full overflow-hidden border-t bg-moonlightOverlay sm:max-w-xl sm:rounded-t-lg sm:border-x"
		>
			<div class="h-full w-full overflow-y-auto">
				<div
					class="sticky top-0 z-10 flex items-center justify-between bg-gradient-to-b from-moonlightOverlay to-transparent p-3.5 pb-4"
				>
					<div>
						<h1 id="project-info-title" class="text-2xl font-light">
						</h1>
						<h2 id="project-info-date" class="text-moonlightText">
						</h2>
					</div>
					<button id="project-info-close">
						<Close
							width={30}
							height={30}
							class="text-moonlightOrange"
						/>
					</button>
				</div>
				<div class="space-y-4 px-3.5">
					<hr />
					<img
						id="project-info-image"
						alt="project showcase image"
						class="rounded-md object-cover"
					/>
					<div class="flex gap-x-2.5">
						<a
							id="project-info-github"
							href="/"
							target="_blank"
							class="flex w-full items-center justify-center gap-x-3 rounded-md bg-moonlightFocusHigh p-3 transition-all hover:brightness-125"
						>
							<GitHub width={25} height={25} />
							<p>github</p>
						</a>
						<a
							id="project-info-url"
							href="/"
							target="_blank"
							class="flex w-full items-center justify-center gap-x-3 rounded-md bg-moonlightIndigo p-3 text-moonlightBase transition-all hover:brightness-125"
						>
							<p>site</p>
							<RightArrow width={25} height={25} />
						</a>
					</div>
					<div
						class="prose prose-invert prose-img:mt-0 prose-img:rounded-md prose-video:mt-0 prose-video:rounded-md [&_lite-youtube]:mb-8"
					>
						{
							projectReadmes.map(({ id, md }) => (
								<div id={`project-${id}`} class="hidden">
									<md.Content />
								</div>
							))
						}
						{
							projectsWithoutReadmes.map(
								({ id, description }) => (
									<div id={`project-${id}`} class="hidden">
										{description}
										<hr />
										<p>[write-up coming soon]</p>
									</div>
								)
							)
						}
					</div>
				</div>
			</div>
		</div>
	</div>
</Layout>

<style>
	#intro a {
		@apply text-moonlightBlue underline;
	}

	.appear {
		animation: fade-in 1s cubic-bezier(0.45, 0.02, 0.09, 0.98) forwards;
	}

	@keyframes fade-in {
		0% {
			opacity: 0%;
		}
		100% {
			opacity: 100%;
		}
	}

	.bounce {
		animation: bounce 0.4s ease 1s;
	}

	@keyframes bounce {
		75% {
			transform: translateY(-10%);
		}
		100% {
			transform: translateY(0%);
		}
	}

	.info-transition-options {
		will-change: transform;
		transition-property: transform;
		transition-timing-function: cubic-bezier(0.32, 0.72, 0, 1);
		transition-duration: 750ms;
	}

	.info-die {
		transform: translateY(0px);
	}
</style>

<style is:global>
	.background-transition-options {
		transition-property: transform, filter, border;
		transition-timing-function: cubic-bezier(0.16, 1, 0.3, 1);
		transition-duration: 1250ms;
	}

	.background-die {
		transform: rotate(1.5deg) scale(0.75);
		filter: saturate(50%);
	}
</style>

<script>
	import { oceanScript } from "../components/ocean/ocean";
	import type { Project } from "../utils";

	document.getElementById("time")!.textContent =
		new Date().toLocaleString("en-US", {
			timeZone: "America/New_York",
			hour: "numeric",
			minute: "numeric",
			hour12: true,
		}) + " EDT";

	const oceanControls = oceanScript();

	const ocean = document.getElementById("ocean-component")!;
	const waves = document.getElementById("waves-container")!;
	const projectOpeners = document.querySelectorAll<HTMLButtonElement>(
		".project-open-button"
	);
	const projectInfoContainer = document.getElementById(
		"project-info-container"
	)!;
	const projectInfoTitle = document.getElementById("project-info-title")!;
	const projectInfoDate = document.getElementById("project-info-date")!;
	const projectInfoImage = document.getElementById(
		"project-info-image"
	)! as HTMLImageElement;
	const projectInfoGithub = document.getElementById(
		"project-info-github"
	)! as HTMLLinkElement;
	const projectInfoUrl = document.getElementById(
		"project-info-url"
	)! as HTMLLinkElement;
	const projectInfoClose = document.getElementById("project-info-close")!;

	const projectData = JSON.parse(
		projectInfoContainer.dataset.projects!
	) as (Project & { id: string; year: number })[];

	const projectReadmeRefs = Object.fromEntries(
		projectData.map(({ id }) => [
			id,
			document.getElementById(`project-${id}`),
		])
	);

	projectOpeners.forEach((button) => {
		button.addEventListener("click", (event) => {
			if (
				(event.target as HTMLElement)?.parentElement?.nodeName !== "A"
			) {
				die(button.dataset.id!);
			}
		});
	});

	projectInfoClose.addEventListener("click", () => revive());

	projectInfoContainer.addEventListener("click", (event) => {
		if (event.target === projectInfoContainer) revive();
	});

	document.addEventListener("keydown", (e) => {
		if (e.key === "Escape") revive();
	});

	let open = false;

	function die(id: string) {
		if (open) return;

		oceanControls.stop();

		ocean.classList.add("background-die");
		waves.classList.add("background-die");

		projectInfoContainer.classList.add("info-die");

		for (const readme of Object.values(projectReadmeRefs)) {
			if (readme) readme.classList.add("hidden");
		}

		const readme = projectReadmeRefs[id];
		if (readme) readme.classList.remove("hidden");

		const data = projectData.find((project) => project.id === id)!;

		projectInfoImage.src = data.thumbnail;
		projectInfoTitle.textContent = data.name;
		projectInfoDate.textContent = `${data.year}`;

		if (data.repo) {
			projectInfoGithub.classList.remove("hidden");
			projectInfoGithub.href = data.repo;
		} else {
			projectInfoGithub.classList.add("hidden");
		}

		if (data.url) {
			projectInfoUrl.classList.remove("hidden");
			projectInfoUrl.href = data.url;
		} else {
			projectInfoUrl.classList.add("hidden");
		}

		open = true;
	}

	function revive() {
		if (!open) return;

		ocean.classList.remove("background-die");
		waves.classList.remove("background-die");

		projectInfoContainer.classList.remove("info-die");

		oceanControls.resume();

		open = false;
	}
</script>
